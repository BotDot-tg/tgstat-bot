from aiogram import types

from keyboards.inline.menu_keyboard import pay
from loader import dp
from tgstat_parser import get_channels, get_citate, get_stat
from utils.db_api.db_commands import get_client, update_is_trial, get_client_request, update_amount_client


@dp.message_handler(state='*')
async def get_key(message: types.Message):
    key = message.text
    client = await get_client(telegram_id=message.from_user.id)
    data = await get_client_request(telegram_id=message.from_user.id)
    if data:
        await message.answer('‚õîÔ∏è –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å. –û–∂–∏–¥–∞–π—Ç–µ.')
    else:
        if client.is_trial is False:
            await message.answer(f'‚úÖ –ù–∞—á–∞–ª—Å—è –ø—Ä–æ–±–Ω—ã–π –ø–æ–¥–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∫–ª—é—á–µ–≤–æ–º—É —Å–ª–æ–≤—É "{key}"\n\n'
                                 f'‚ö†Ô∏è –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≥–ª—É–±–∏–Ω—ã –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –º–æ–∂–µ—Ç –¥–ª–∏—Ç—å—Å—è –æ—Ç 5 –¥–æ 10 –º–∏–Ω—É—Ç.\n'
                                 f'üï• –í –∫–æ–Ω–µ—á–Ω–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –≤–∞–º –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ Excel-—Ç–∞–±–ª–∏—Ü–∞. –û–∂–∏–¥–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è!')
            await update_is_trial(telegram_id=message.from_user.id)
            await get_channels(key=key, telegram_id=message.from_user.id, limit=30)
            await message.answer('‚ùå –í—ã —É–∂–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏ –±–æ—Ç–∞.\n\n'
                                 'üòî–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–æ–≤, –∞ —Ç–∞–∫ –∂–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –±–æ—Ç–∞ –ø–æ API —Å —Ç–∞–∫–∏–º–∏ –ø–ª–æ—â–∞–¥–∫–∞–º–∏ –∫–∞–∫\n'
                                 'TGstat, Telemetr –Ω–µ –ø–æ–∑–≤–æ–ª—è—é—Ç —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏ –Ω–∞–º –¥–∞–≤–∞—Ç—å –±–æ–ª–µ–µ –æ–¥–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏. –ù–µ–π—Ä–æ—Å–µ—Ç—å –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤–ø—Ä–æ–≥–æ–ª–æ–¥—å –∏ –Ω–∞—á–Ω–µ—Ç –±–∞—Ä–∞—Ö–ª–∏—Ç—å\n\n'
                                 '‚úâÔ∏è–ü–æ—ç—Ç–æ–º—É, –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–º —Ä–∞–±–æ—Ç—ã –ø—Ä–æ—Å–∏–º –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–∞—Ä–∏—Ñ–∞–º–∏ –Ω–∏–∂–µ.\n'
                                 '–û–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –Ω–∏–º–∏ –≤—ã —Ç–∞–∫ –∂–µ –º–æ–∂–µ—Ç–µ –ø–æ –∫–Ω–æ–ø–∫–∞–º.', reply_markup=pay)

        elif client.subscribe is False:
            await message.answer('‚ùå –í—ã —É–∂–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏ –±–æ—Ç–∞.\n\n'
                                 'üòî–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–æ–≤, –∞ —Ç–∞–∫ –∂–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –±–æ—Ç–∞ –ø–æ API —Å —Ç–∞–∫–∏–º–∏ –ø–ª–æ—â–∞–¥–∫–∞–º–∏ –∫–∞–∫\n'
                                 'TGstat, Telemetr –Ω–µ –ø–æ–∑–≤–æ–ª—è—é—Ç —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏ –Ω–∞–º –¥–∞–≤–∞—Ç—å –±–æ–ª–µ–µ –æ–¥–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏. –ù–µ–π—Ä–æ—Å–µ—Ç—å –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤–ø—Ä–æ–≥–æ–ª–æ–¥—å –∏ –Ω–∞—á–Ω–µ—Ç –±–∞—Ä–∞—Ö–ª–∏—Ç—å\n\n'
                                 '‚úâÔ∏è–ü–æ—ç—Ç–æ–º—É, –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–º —Ä–∞–±–æ—Ç—ã –ø—Ä–æ—Å–∏–º –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–∞—Ä–∏—Ñ–∞–º–∏ –Ω–∏–∂–µ.\n'
                                 '–û–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –Ω–∏–º–∏ –≤—ã —Ç–∞–∫ –∂–µ –º–æ–∂–µ—Ç–µ –ø–æ –∫–Ω–æ–ø–∫–∞–º.', reply_markup=pay)

        else:
            if client.amount == 0:
                await message.answer('‚ùå –ó–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –∑–∞–ø—Ä–æ—Å—ã.\n\n'
                                     'üòî–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –≤–∞—à–µ–π –ø–æ–¥–ø–∏—Å–∫–µ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å.\n'
                                     '–ü—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –≤—ã –º–æ–∂–µ—Ç–µ –≤ –º–µ–Ω—é –≤–∞—à–µ–π –ø–æ–¥–ø–∏—Å–∫–∏.', reply_markup=pay)
            else:
                await message.answer(f'‚úÖ –ù–∞—á–∞–ª—Å—è –ø–æ–¥–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∫–ª—é—á–µ–≤–æ–º—É —Å–ª–æ–≤—É "{key}"\n\n'
                                     f'‚ö†Ô∏è –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≥–ª—É–±–∏–Ω—ã –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –º–æ–∂–µ—Ç –¥–ª–∏—Ç—å—Å—è –æ—Ç 5 –¥–æ 10 –º–∏–Ω—É—Ç.\n'
                                     f'üï• –í –∫–æ–Ω–µ—á–Ω–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –≤–∞–º –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ Excel-—Ç–∞–±–ª–∏—Ü–∞. –û–∂–∏–¥–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è!')
                await update_amount_client(telegram_id=message.from_user.id)
                await get_channels(key=key, telegram_id=message.from_user.id, limit=100)
